# requirements.md（ReAct型データ分析AIエージェント）

## 背景・目的

ユーザーがアップロードしたCSVに対して、対話しながら分析を進め、最終的に**Markdownレポート形式**で結果をUI表示できるReAct型データ分析エージェントを提供する。

## スコープ

### IN（対象）

- Streamlit UIでの対話
- CSVアップロード（UI経由）
- ReActによる「分析を実行するべきか / 追加質問するべきか」の自律判断
- 対応分析（MVP）:
  - EDA（データ概要、欠損、基本統計、列要約、重複チェック）
  - groupby集計（フィルタ・並べ替え・top-k・構成比/パレート含む）
  - 基本プロット（例: hist / scatter / line / bar / box）
  - 必要に応じた相関（例: 相関係数、相関行列）
- グラフ表示（UI上）
- 最終レポート表示（Markdown、最低限: 結論・根拠・再現要約）
- 必要に応じて実行内容（コード等）をUIで折りたたみ表示

### OUT（対象外）

- Web検索・外部API呼び出し等（**OpenAI以外の外部通信**）
- ローカルファイルシステムへの read/write（アップロード後に保存しない）
- モデリング（予測/分類）などMVP範囲外の高度分析（将来拡張）

## 機能要件（EARS）

### 対話

- REQ-CHAT-001: ユーザーがメッセージを送信した**とき**、エージェントは対話を継続できる形で応答**しなければならない**。

### データ取り込み（UI経由）

- REQ-DATA-001: ユーザーがCSVをアップロードした**とき**、エージェントはデータ概要（行数/列数/列名/型）を提示**しなければならない**。

### ReAct（判断・質問・仮定）

- REQ-REACT-001: ユーザーが分析要求を行った**とき**、エージェントは要求の明確性を評価し、十分明確なら分析を実行し、不明確なら追加質問を行う、を選択**しなければならない**。
- REQ-REACT-002: エージェントが追加質問を行う**とき**、分析に必要な不足情報（例: 対象列、粒度、指標、フィルタ条件）を埋める**最小限の質問**を提示**しなければならない**。
- REQ-REACT-003: 返答が得られない/なお不明確な**場合**、エージェントは合理的な仮定案を提示し「この仮定で進めてよいか」を確認**しなければならない**。

### 分析実行（MVP）

- REQ-ACT-001: エージェントが分析を実行すると判断した**とき**、**ユーザー要求（および合意した追加提案）に必要な範囲で**、EDA/集計/可視化/相関のうち適切なものを実行**しなければならない**。
- REQ-PLOT-001: ユーザーがグラフ表示を要求した**とき**、エージェントは要求に適した可視化を生成し、UIに表示**しなければならない**。
- REQ-CORR-001: ユーザーが「相関見せて」等の相関分析を要求し、対象列が指定されていない**とき**、エージェントは全数値列を候補とし、列数が多い場合は上位N列（デフォルトN=10）に絞って相関行列を提示**しなければならない**。上位N列の選定は、ユーザーが特定の列を指定した場合はその列を必ず含め、残りは分散が大きい順で選定する。
- REQ-FILTER-001: ユーザーが期間指定や条件指定等のフィルタを含む分析を要求した**とき**、エージェントは `filters` として構造化し、指定された条件に基づいてデータを絞り込んで分析を実行**しなければならない**。

### レポート

- REQ-REPORT-001: エージェントが最終結果を提示する**とき**、結果をMarkdownレポートとして（少なくとも**結論・根拠・再現要約**を含めて）UIに表示**しなければならない**。
- REQ-REPORT-002: 仮定に基づいて分析を進めた**とき**、その仮定を最終レポートに明記**しなければならない**。

### 完了条件

- REQ-DONE-001: エージェントがユーザー要求を満たしたと判断した**場合**、自動的に最終レポートを確定して提示**しなければならない**。
- REQ-DONE-002: エージェントが最終レポートを確定して提示する**とき**、追加の深掘り分析案がある場合は「任意の提案」として添えて提示してもよい。

## 非機能要件（NFR）

### ネットワーク

- NFR-NET-001: ネットワーク通信は **OpenAI（LLM API）への通信のみ許可**し、それ以外の外部通信を行ってはならない。

### ファイルシステム

- NFR-FS-001: ローカルファイルシステムへの read/write を行ってはならない（アップロード後はメモリ上で処理し、図もメモリ生成してUI表示のみとする）。

### リソース制限

- NFR-RES-001: 1回の分析アクションは **30秒以内 / 1GB以内**に制限されなければならない。

### 許可ライブラリ

- NFR-LIB-001: 実行で利用可能なライブラリは **pandas/numpy/sklearn/matplotlib/seaborn** に制限されなければならない。

### 入力データ想定

- NFR-DATA-001: 入力CSVは暫定で「中（〜100MB/〜100万行）」を想定し、超える場合は縮小（例: サンプリング/列絞り）方針を提示しなければならない。

## 実装方針メモ（要件補足）

- データはStreamlit(UI)が `dataset_id` + プロセス内レジストリで保持し、エージェントStateは軽量参照（`dataset_id`、`dataset_summary` 等）を保持する。
- reasonノードはユーザー要求を解釈し、act側には構造化spec（JSON相当）で指示する（実行の再現性・テスト容易性を確保する）。
- `filters` のMVP仕様は以下とする。
  - 条件結合: **ANDのみ**
  - 演算子: `==`, `!=`, `>`, `>=`, `<`, `<=`, `in`, `contains`, `is_null`, `not_null`
  - 日付/日時: 文字列からの自動パースを試み、パースに失敗した場合は追加質問またはエラーとして扱う（黙って無視しない）


